# Marketplace Phase 5 Verification Runbook

This runbook covers the verification script for Marketplace Phase 2 completion and the pilot rollout sequence.

## Scope

- Webhook contract checks per provider:
  - valid signature accepted
  - invalid signature rejected
  - duplicate event idempotency
  - out-of-order event tolerance
- End-to-end flow:
  - inbound webhook creates internal order
  - order appears in active queue (`pending/confirmed/preparing/ready`)
  - internal status transitions create outbound sync jobs
  - sync jobs reach observable terminal state (`SUCCESS`/`FAILED`/`DEAD_LETTER`)

## Script

- File: `scripts/verify-marketplace-phase5.ts`
- NPM commands:
  - `npm run verify:marketplace:phase5`
  - `npm run verify:marketplace:phase5:contract`
  - `npm run verify:marketplace:phase5:e2e`
- Pilot gate report script:
  - File: `scripts/marketplace-pilot-gate-report.ts`
  - Command: `npm run pilot:marketplace:gates`

## Required Environment

- `MARKETPLACE_VERIFY_API_BASE_URL` (default: `http://localhost:3000/api`)
- Auth:
  - Option A: `MARKETPLACE_VERIFY_EMAIL`, `MARKETPLACE_VERIFY_PASSWORD`
  - Option B: `MARKETPLACE_VERIFY_TOKEN`, `MARKETPLACE_VERIFY_RESTAURANT_ID`
- Provider selector:
  - `MARKETPLACE_VERIFY_PROVIDER` (`doordash_marketplace` | `ubereats` | `grubhub`)

## Optional Environment

- `MARKETPLACE_VERIFY_MODE` (`all` | `contract` | `e2e`) when not passing CLI mode arg
- `MARKETPLACE_VERIFY_STORE_ID` (autogenerated if omitted)
- `MARKETPLACE_VERIFY_WEBHOOK_SECRET` (autogenerated if omitted)

## Local Example

```bash
MARKETPLACE_VERIFY_API_BASE_URL=http://localhost:3000/api \
MARKETPLACE_VERIFY_EMAIL=owner@taipa.com \
MARKETPLACE_VERIFY_PASSWORD=owner123 \
MARKETPLACE_VERIFY_PROVIDER=doordash_marketplace \
npm run verify:marketplace:phase5
```

## Pilot Rollout Sequence

1. Run contract + e2e checks on pilot DoorDash restaurant.
2. Validate Control Panel integration status and menu mappings for pilot restaurant.
3. Monitor sync jobs:
   - `GET /api/restaurant/:restaurantId/marketplace/status-sync/jobs`
4. Evaluate stop/go gate summary:
   - `GET /api/restaurant/:restaurantId/marketplace/pilot/summary?windowHours=24`
   - `npm run pilot:marketplace:gates`
5. Resolve dead-letter/failed jobs before enabling additional restaurants.
6. Repeat with Uber Eats pilot restaurants.
7. Expand to broader cohort only after stable pilot metrics.
8. Keep Grubhub feature-gated unless API partnership access is confirmed.

## Pilot Gate Thresholds

Thresholds are enforced by `/marketplace/pilot/summary` and can be tuned with environment variables.

- `MARKETPLACE_PILOT_MAX_DEAD_LETTER` (default: `0`)
- `MARKETPLACE_PILOT_MAX_BAD_SIGNATURE` (default: `0`)
- `MARKETPLACE_PILOT_MAX_HOLD_FOR_REVIEW` (default: `0`)
- `MARKETPLACE_PILOT_MAX_WEBHOOK_FAILED` (default: `0`)
- `MARKETPLACE_PILOT_MIN_TERMINAL_SAMPLE` (default: `5`)
- `MARKETPLACE_PILOT_MIN_SUCCESS_RATE_PERCENT` (default: `95`)

## Exit Checks

- No critical webhook ingestion failures in pilot window.
- Duplicate events consistently return `status=duplicate`.
- Invalid signatures consistently return HTTP `400`.
- Outbound status sync failures are observable and retryable.
- Operator UI can clearly identify marketplace source and sync health.

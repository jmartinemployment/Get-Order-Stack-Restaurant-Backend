generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Restaurant {
  id               String   @id @default(uuid())
  slug             String   @unique
  name             String
  description      String?
  logo             String?
  phone            String?
  email            String?
  address          String?
  city             String?
  state            String?
  zip              String?
  location         String?
  latitude         Decimal?  @db.Decimal(10, 7)
  longitude        Decimal?  @db.Decimal(10, 7)
  cuisineType      String?  @map("cuisine_type")
  tier             Int      @default(1)
  monthlyRevenue   Decimal? @db.Decimal(10, 2) @map("monthly_revenue")
  deliveryPercent  Int?     @map("delivery_percentage")
  platformsUsed    String[] @default([]) @map("platforms_used")
  posSystem        String?  @map("pos_system")
  taxRate          Decimal  @default(0) @db.Decimal(5, 4) @map("tax_rate")
  deliveryEnabled  Boolean  @default(true) @map("delivery_enabled")
  pickupEnabled    Boolean  @default(true) @map("pickup_enabled")
  dineInEnabled    Boolean  @default(true) @map("dine_in_enabled")
  active           Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  primaryCategories PrimaryCategory[]
  menuCategories    MenuCategory[]
  menuItems         MenuItem[]
  modifierGroups    ModifierGroup[]
  customers         Customer[]
  orders            Order[]
  reservations      Reservation[]
  tables            RestaurantTable[]
  inventoryItems    InventoryItem[]
  userAccess        UserRestaurantAccess[]
  restaurantGroupId String? @map("restaurant_group_id")
  restaurantGroup   RestaurantGroup? @relation(fields: [restaurantGroupId], references: [id], onDelete: SetNull)

  @@map("restaurants")
}

// === PRIMARY CATEGORIES (Top-level nav grouping) ===

model PrimaryCategory {
  id            String   @id @default(uuid())
  restaurantId  String   @map("restaurant_id")
  slug          String   @db.VarChar(50)
  name          String   @db.VarChar(100)
  nameEn        String?  @map("name_en") @db.VarChar(100)
  icon          String?  @db.VarChar(50)
  displayOrder  Int      @default(0) @map("display_order")
  active        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  restaurant     Restaurant     @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuCategories MenuCategory[]

  @@unique([restaurantId, slug])
  @@index([restaurantId])
  @@map("primary_categories")
}

// === MENU CATEGORIES (Subcategories) ===

model MenuCategory {
  id                String   @id @default(uuid())
  restaurantId      String   @map("restaurant_id")
  primaryCategoryId String?  @map("primary_category_id")
  name              String
  nameEn            String?  @map("name_en")
  description       String?
  descriptionEn     String?  @map("description_en")
  displayOrder      Int      @default(0) @map("display_order")
  image             String?
  active            Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  restaurant      Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  primaryCategory PrimaryCategory? @relation(fields: [primaryCategoryId], references: [id], onDelete: SetNull)
  menuItems       MenuItem[]

  @@index([primaryCategoryId])
  @@map("menu_categories")
}

model MenuItem {
  id               String    @id @default(uuid())
  restaurantId     String    @map("restaurant_id")
  categoryId       String    @map("category_id")
  name             String
  nameEn           String?   @map("name_en")
  description      String
  descriptionEn    String?   @map("description_en")
  price            Decimal   @db.Decimal(10, 2)
  cost             Decimal?  @db.Decimal(10, 2)
  image            String?
  available        Boolean   @default(true)
  eightySixed      Boolean   @default(false) @map("eighty_sixed")
  eightySixReason  String?   @map("eighty_six_reason")
  popular          Boolean   @default(false)
  dietary          String[]  @default([])
  displayOrder     Int       @default(0) @map("display_order")
  prepTimeMinutes  Int?      @map("prep_time_minutes")
  taxCategory      String    @default("prepared_food") @map("tax_category")
  aiEstimatedCost  Decimal?  @db.Decimal(10, 2) @map("ai_estimated_cost")
  aiSuggestedPrice Decimal?  @db.Decimal(10, 2) @map("ai_suggested_price")
  aiProfitMargin   Decimal?  @db.Decimal(5, 2) @map("ai_profit_margin")
  aiConfidence     String?   @map("ai_confidence")
  aiLastUpdated    DateTime? @map("ai_last_updated")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  restaurant        Restaurant              @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category          MenuCategory            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  orderItems        OrderItem[]
  modifierGroups    MenuItemModifierGroup[]
  recipeIngredients RecipeIngredient[]

  @@map("menu_items")
}

// === MODIFIER SYSTEM ===

model ModifierGroup {
  id            String   @id @default(uuid())
  restaurantId  String   @map("restaurant_id")
  name          String
  nameEn        String?  @map("name_en")
  description   String?
  descriptionEn String?  @map("description_en")
  required      Boolean  @default(false)
  multiSelect   Boolean  @default(false) @map("multi_select")
  minSelections Int      @default(0) @map("min_selections")
  maxSelections Int?     @map("max_selections")
  displayOrder  Int      @default(0) @map("display_order")
  active        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  restaurant Restaurant              @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  modifiers  Modifier[]
  menuItems  MenuItemModifierGroup[]

  @@map("modifier_groups")
}

model Modifier {
  id              String   @id @default(uuid())
  modifierGroupId String   @map("modifier_group_id")
  name            String
  nameEn          String?  @map("name_en")
  priceAdjustment Decimal  @default(0) @db.Decimal(10, 2) @map("price_adjustment")
  isDefault       Boolean  @default(false) @map("is_default")
  available       Boolean  @default(true)
  displayOrder    Int      @default(0) @map("display_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  modifierGroup      ModifierGroup       @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  orderItemModifiers OrderItemModifier[]

  @@map("modifiers")
}

model MenuItemModifierGroup {
  id              String @id @default(uuid())
  menuItemId      String @map("menu_item_id")
  modifierGroupId String @map("modifier_group_id")
  displayOrder    Int    @default(0) @map("display_order")

  menuItem      MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifierGroup ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, modifierGroupId])
  @@map("menu_item_modifier_groups")
}

// === TABLE MANAGEMENT ===

model RestaurantTable {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  tableNumber  String   @map("table_number")
  tableName    String?  @map("table_name")
  capacity     Int      @default(4)
  section      String?
  status       String   @default("available")
  posX         Int?     @map("pos_x")
  posY         Int?     @map("pos_y")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orders     Order[]

  @@unique([restaurantId, tableNumber])
  @@map("restaurant_tables")
}

// === CUSTOMERS ===

model Customer {
  id              String    @id @default(uuid())
  restaurantId    String    @map("restaurant_id")
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  email           String?
  phone           String?
  totalOrders     Int       @default(0) @map("total_orders")
  totalSpent      Decimal   @default(0) @db.Decimal(10, 2) @map("total_spent")
  avgOrderValue   Decimal?  @db.Decimal(10, 2) @map("average_order_value")
  lastOrderDate   DateTime? @map("last_order_date")
  loyaltyPoints   Int       @default(0) @map("loyalty_points")
  tags            String[]  @default([])
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orders       Order[]
  reservations Reservation[]

  @@map("customers")
}

// === ORDERS ===

model Order {
  id                    String    @id @default(uuid())
  restaurantId          String    @map("restaurant_id")
  customerId            String?   @map("customer_id")
  tableId               String?   @map("table_id")
  serverId              String?   @map("server_id")
  orderNumber           String    @unique @map("order_number")
  orderType             String    @map("order_type")
  orderSource           String    @default("online") @map("order_source")
  status                String    @default("pending")
  subtotal              Decimal   @db.Decimal(10, 2)
  tax                   Decimal   @db.Decimal(10, 2)
  tip                   Decimal   @default(0) @db.Decimal(10, 2)
  discount              Decimal   @default(0) @db.Decimal(10, 2)
  deliveryFee           Decimal   @default(0) @db.Decimal(10, 2) @map("delivery_fee")
  total                 Decimal   @db.Decimal(10, 2)
  paymentMethod         String?   @map("payment_method")
  paymentStatus         String    @default("pending") @map("payment_status")
  stripePaymentIntentId String?   @map("stripe_payment_intent_id")
  specialInstructions   String?   @map("special_instructions")
  deliveryAddress       String?   @map("delivery_address")
  deliveryLat           Decimal?  @db.Decimal(10, 7) @map("delivery_lat")
  deliveryLng           Decimal?  @db.Decimal(10, 7) @map("delivery_lng")
  deliveryProvider      String?   @map("delivery_provider")
  deliveryTrackingUrl   String?   @map("delivery_tracking_url")
  scheduledTime         DateTime? @map("scheduled_time")
  sentToKitchenAt       DateTime? @map("sent_to_kitchen_at")
  confirmedAt           DateTime? @map("confirmed_at")
  preparingAt           DateTime? @map("preparing_at")
  readyAt               DateTime? @map("ready_at")
  completedAt           DateTime? @map("completed_at")
  cancelledAt           DateTime? @map("cancelled_at")
  cancellationReason    String?   @map("cancellation_reason")
  cancelledBy           String?   @map("cancelled_by")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  restaurant    Restaurant           @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  customer      Customer?            @relation(fields: [customerId], references: [id], onDelete: SetNull)
  table         RestaurantTable?     @relation(fields: [tableId], references: [id], onDelete: SetNull)
  orderItems    OrderItem[]
  statusHistory OrderStatusHistory[]

  @@map("orders")
}

model OrderItem {
  id                  String   @id @default(uuid())
  orderId             String   @map("order_id")
  menuItemId          String?  @map("menu_item_id")
  menuItemName        String   @map("menu_item_name")
  quantity            Int
  unitPrice           Decimal  @db.Decimal(10, 2) @map("unit_price")
  modifiersPrice      Decimal  @default(0) @db.Decimal(10, 2) @map("modifiers_price")
  totalPrice          Decimal  @db.Decimal(10, 2) @map("total_price")
  specialInstructions String?  @map("special_instructions")
  status              String   @default("pending")
  sentToKitchenAt     DateTime? @map("sent_to_kitchen_at")
  completedAt         DateTime? @map("completed_at")
  createdAt           DateTime @default(now()) @map("created_at")

  order     Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem  MenuItem?           @relation(fields: [menuItemId], references: [id], onDelete: SetNull)
  modifiers OrderItemModifier[]

  @@map("order_items")
}

model OrderItemModifier {
  id              String  @id @default(uuid())
  orderItemId     String  @map("order_item_id")
  modifierId      String? @map("modifier_id")
  modifierName    String  @map("modifier_name")
  priceAdjustment Decimal @db.Decimal(10, 2) @map("price_adjustment")

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifier  Modifier? @relation(fields: [modifierId], references: [id], onDelete: SetNull)

  @@map("order_item_modifiers")
}

// === RESERVATIONS ===

model Reservation {
  id               String    @id @default(uuid())
  restaurantId     String    @map("restaurant_id")
  customerId       String?   @map("customer_id")
  customerName     String    @map("customer_name")
  customerPhone    String    @map("customer_phone")
  customerEmail    String?   @map("customer_email")
  partySize        Int       @map("party_size")
  reservationTime  DateTime  @map("reservation_time")
  tableNumber      String?   @map("table_number")
  status           String    @default("pending")
  specialRequests  String?   @map("special_requests")
  confirmationSent Boolean   @default(false) @map("confirmation_sent")
  reminderSent     Boolean   @default(false) @map("reminder_sent")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  customer   Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@map("reservations")
}

// === TAX JURISDICTIONS (AI-populated lookup table) ===

model TaxJurisdiction {
  id           String    @id @default(uuid())
  zipCode      String    @map("zip_code")
  city         String?
  county       String?
  state        String    @default("FL")
  taxRate      Decimal   @db.Decimal(5, 4) @map("tax_rate")
  breakdown    Json?
  source       String    @default("ai")
  verifiedAt   DateTime? @map("verified_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@unique([zipCode, state])
  @@map("tax_jurisdictions")
}

// === ORDER STATUS TRACKING ===

model OrderStatusHistory {
  id         String   @id @default(uuid())
  orderId    String   @map("order_id")
  fromStatus String?  @map("from_status")
  toStatus   String   @map("to_status")
  changedBy  String?  @map("changed_by")
  note       String?
  createdAt  DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_status_history")
}

// === INVENTORY MANAGEMENT ===

model InventoryItem {
  id            String    @id @default(uuid())
  restaurantId  String    @map("restaurant_id")
  name          String    @db.VarChar(255)
  nameEn        String?   @map("name_en") @db.VarChar(255)
  unit          String    @default("units") @db.VarChar(50)
  currentStock  Decimal   @default(0) @db.Decimal(10, 2) @map("current_stock")
  minStock      Decimal   @default(0) @db.Decimal(10, 2) @map("min_stock")
  maxStock      Decimal   @default(100) @db.Decimal(10, 2) @map("max_stock")
  costPerUnit   Decimal   @default(0) @db.Decimal(10, 4) @map("cost_per_unit")
  supplier      String?   @db.VarChar(255)
  category      String    @default("general") @db.VarChar(100)
  lastRestocked DateTime? @map("last_restocked")
  lastCountDate DateTime? @map("last_count_date")
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  restaurant        Restaurant         @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  logs              InventoryLog[]
  recipeIngredients RecipeIngredient[]

  @@index([restaurantId])
  @@index([restaurantId, category])
  @@map("inventory_items")
}

model InventoryLog {
  id              String   @id @default(uuid())
  inventoryItemId String   @map("inventory_item_id")
  previousStock   Decimal  @db.Decimal(10, 2) @map("previous_stock")
  newStock        Decimal  @db.Decimal(10, 2) @map("new_stock")
  changeAmount    Decimal  @db.Decimal(10, 2) @map("change_amount")
  reason          String?  @db.VarChar(255)
  createdBy       String?  @map("created_by") @db.VarChar(255)
  createdAt       DateTime @default(now()) @map("created_at")

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([inventoryItemId])
  @@index([createdAt])
  @@map("inventory_logs")
}

model RecipeIngredient {
  id              String   @id @default(uuid())
  menuItemId      String   @map("menu_item_id")
  inventoryItemId String   @map("inventory_item_id")
  quantity        Decimal  @db.Decimal(10, 4)
  unit            String   @db.VarChar(50)
  notes           String?  @db.VarChar(255)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  menuItem      MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, inventoryItemId])
  @@index([menuItemId])
  @@index([inventoryItemId])
  @@map("recipe_ingredients")
}

// === AUTHENTICATION & AUTHORIZATION ===

model RestaurantGroup {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  logo        String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users       User[]
  restaurants Restaurant[]

  @@map("restaurant_groups")
}

model User {
  id                String    @id @default(uuid())
  restaurantGroupId String?   @map("restaurant_group_id")
  email             String    @unique
  passwordHash      String    @map("password_hash")
  firstName         String?   @map("first_name")
  lastName          String?   @map("last_name")
  role              String    @default("staff") // super_admin, owner, manager, staff
  isActive          Boolean   @default(true) @map("is_active")
  lastLoginAt       DateTime? @map("last_login_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  restaurantGroup  RestaurantGroup?       @relation(fields: [restaurantGroupId], references: [id], onDelete: SetNull)
  restaurantAccess UserRestaurantAccess[]
  sessions         UserSession[]

  @@index([restaurantGroupId])
  @@map("users")
}

model UserRestaurantAccess {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  restaurantId String   @map("restaurant_id")
  role         String   @default("staff") // owner, manager, staff
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@index([restaurantId])
  @@map("user_restaurant_access")
}

model UserSession {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  token      String   @unique
  deviceInfo String?  @map("device_info")
  ipAddress  String?  @map("ip_address")
  isActive   Boolean  @default(true) @map("is_active")
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_sessions")
}

model StaffPin {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  pin          String   // hashed 4-6 digit PIN
  name         String   // display name
  role         String   @default("staff")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([restaurantId])
  @@map("staff_pins")
}

model Station {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  name         String   // e.g., "Grill", "Fry", "Cold", "Expo"
  displayOrder Int      @default(0) @map("display_order")
  isExpo       Boolean  @default(false) @map("is_expo")
  color        String?
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([restaurantId, name])
  @@index([restaurantId])
  @@map("stations")
}

model Device {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  deviceId     String   @unique @map("device_id")
  deviceType   String   @map("device_type") // 'kds', 'pos', 'tablet'
  deviceName   String?  @map("device_name")
  isActive     Boolean  @default(true) @map("is_active")
  lastSeenAt   DateTime? @map("last_seen_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([restaurantId])
  @@map("devices")
}

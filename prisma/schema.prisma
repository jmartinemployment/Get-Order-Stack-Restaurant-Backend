generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Restaurant {
  id               String   @id @default(uuid())
  slug             String   @unique
  name             String
  description      String?
  logo             String?
  phone            String?
  email            String?
  address          String?
  city             String?
  state            String?
  zip              String?
  location         String?
  latitude         Decimal?  @db.Decimal(10, 7)
  longitude        Decimal?  @db.Decimal(10, 7)
  cuisineType      String?  @map("cuisine_type")
  tier             Int      @default(1)
  monthlyRevenue   Decimal? @db.Decimal(10, 2) @map("monthly_revenue")
  deliveryPercent  Int?     @map("delivery_percentage")
  platformsUsed    String[] @default([]) @map("platforms_used")
  posSystem        String?  @map("pos_system")
  taxRate          Decimal  @default(0) @db.Decimal(5, 4) @map("tax_rate")
  deliveryEnabled  Boolean  @default(true) @map("delivery_enabled")
  pickupEnabled    Boolean  @default(true) @map("pickup_enabled")
  dineInEnabled    Boolean  @default(true) @map("dine_in_enabled")
  aiSettings        Json?    @map("ai_settings")
  merchantProfile   Json?    @map("merchant_profile")
  businessHours     Json?    @map("business_hours")
  active           Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  primaryCategories PrimaryCategory[]
  menuCategories    MenuCategory[]
  menuItems         MenuItem[]
  modifierGroups    ModifierGroup[]
  customers         Customer[]
  orders            Order[]
  reservations      Reservation[]
  tables            RestaurantTable[]
  inventoryItems    InventoryItem[]
  userAccess        UserRestaurantAccess[]
  devices              Device[]
  deviceModes          DeviceMode[]
  printerProfiles      PrinterProfile[]
  peripheralDevices    PeripheralDevice[]
  kioskProfiles        KioskProfile[]
  printers             Printer[]
  restaurantGroupId    String? @map("restaurant_group_id")
  restaurantGroup      RestaurantGroup? @relation(fields: [restaurantGroupId], references: [id], onDelete: SetNull)
  loyaltyConfig        RestaurantLoyaltyConfig?
  loyaltyRewards       LoyaltyReward[]
  loyaltyTransactions  LoyaltyTransaction[]
  deliveryCredentials  RestaurantDeliveryCredentials?
  providerProfiles     RestaurantProviderProfile[]
  providerProfileEvents RestaurantProviderProfileEvent[]
  marketplaceIntegrations MarketplaceIntegration[]
  marketplaceOrders       MarketplaceOrder[]
  marketplaceWebhookEvents MarketplaceWebhookEvent[]
  marketplaceMenuMappings  MarketplaceMenuMapping[]
  marketplaceStatusSyncJobs MarketplaceStatusSyncJob[]
  giftCards            GiftCard[]
  invoices             Invoice[]
  houseAccounts        HouseAccount[]
  campaigns            Campaign[]
  combos               Combo[]
  aiCredentials        RestaurantAiCredentials?
  aiUsageLogs          AiUsageLog[]
  vendors              Vendor[]
  purchaseInvoices     PurchaseInvoice[]
  foodCostRecipes      FoodCostRecipe[]
  locationGroupMemberships LocationGroupMember[]

  @@map("restaurants")
}

model RestaurantDeliveryCredentials {
  id                                String    @id @default(uuid())
  restaurantId                      String    @unique @map("restaurant_id")
  doordashApiKeyEncrypted           String?   @map("doordash_api_key_encrypted")
  doordashSigningSecretEncrypted    String?   @map("doordash_signing_secret_encrypted")
  doordashMode                      String?   @map("doordash_mode")
  uberClientIdEncrypted             String?   @map("uber_client_id_encrypted")
  uberClientSecretEncrypted         String?   @map("uber_client_secret_encrypted")
  uberCustomerIdEncrypted           String?   @map("uber_customer_id_encrypted")
  uberWebhookSigningKeyEncrypted    String?   @map("uber_webhook_signing_key_encrypted")
  createdAt                         DateTime  @default(now()) @map("created_at")
  updatedAt                         DateTime  @updatedAt @map("updated_at")

  restaurant                        Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("restaurant_delivery_credentials")
}

model RestaurantProviderProfile {
  id             String    @id @default(uuid())
  restaurantId   String    @map("restaurant_id")
  provider       String
  configRefMap   Json?     @map("config_ref_map")
  profileVersion Int       @default(1) @map("profile_version")
  profileState   String    @default("ACTIVE") @map("profile_state")
  keyBackend     String    @map("key_backend")
  keyRef         String?   @map("key_ref")
  wrappedDek     String?   @map("wrapped_dek")
  dekVersion     Int       @default(1) @map("dek_version")
  aadHash        String?   @map("aad_hash")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  rotatedAt      DateTime? @map("rotated_at")

  restaurant     Restaurant                      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  events         RestaurantProviderProfileEvent[]

  @@unique([restaurantId, provider])
  @@index([restaurantId, profileState])
  @@index([keyBackend])
  @@map("restaurant_provider_profiles")
}

model RestaurantProviderProfileEvent {
  id             String    @id @default(uuid())
  restaurantId   String    @map("restaurant_id")
  profileId      String?   @map("profile_id")
  provider       String
  action         String
  actor          String?
  profileVersion Int?      @map("profile_version")
  outcome        String
  correlationId  String?   @map("correlation_id")
  metadata       Json?
  createdAt      DateTime  @default(now()) @map("created_at")

  restaurant     Restaurant                 @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  profile        RestaurantProviderProfile? @relation(fields: [profileId], references: [id], onDelete: SetNull)

  @@index([restaurantId, provider, createdAt])
  @@index([profileId, createdAt])
  @@index([correlationId])
  @@map("restaurant_provider_profile_events")
}

model MarketplaceIntegration {
  id                             String    @id @default(uuid())
  restaurantId                   String    @map("restaurant_id")
  provider                       String
  enabled                        Boolean   @default(false)
  externalStoreId                String?   @map("external_store_id")
  webhookSigningSecretEncrypted  String?   @map("webhook_signing_secret_encrypted")
  createdAt                      DateTime  @default(now()) @map("created_at")
  updatedAt                      DateTime  @updatedAt @map("updated_at")

  restaurant                     Restaurant             @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  marketplaceOrders              MarketplaceOrder[]
  webhookEvents                  MarketplaceWebhookEvent[]

  @@unique([restaurantId, provider])
  @@index([provider, externalStoreId])
  @@map("marketplace_integrations")
}

model MarketplaceOrder {
  id                 String    @id @default(uuid())
  restaurantId       String    @map("restaurant_id")
  orderId            String?   @unique @map("order_id")
  integrationId      String?   @map("integration_id")
  provider           String
  externalOrderId    String    @map("external_order_id")
  externalStoreId    String?   @map("external_store_id")
  externalCustomerId String?   @map("external_customer_id")
  status             String    @default("RECEIVED")
  rawPayload         Json?     @map("raw_payload")
  lastEventId        String?   @map("last_event_id")
  lastPushedStatus   String?   @map("last_pushed_status")
  lastPushAt         DateTime? @map("last_push_at")
  lastPushResult     String?   @map("last_push_result")
  lastPushError      String?   @map("last_push_error")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  restaurant         Restaurant             @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  order              Order?                 @relation(fields: [orderId], references: [id], onDelete: SetNull)
  integration        MarketplaceIntegration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)
  statusSyncJobs     MarketplaceStatusSyncJob[]

  @@unique([provider, externalOrderId])
  @@index([restaurantId, provider, status])
  @@map("marketplace_orders")
}

model MarketplaceWebhookEvent {
  id              String    @id @default(uuid())
  restaurantId    String?   @map("restaurant_id")
  integrationId   String?   @map("integration_id")
  provider        String
  externalEventId String    @map("external_event_id")
  externalOrderId String?   @map("external_order_id")
  payloadHash     String    @map("payload_hash")
  payload         Json?
  outcome         String    @default("RECEIVED")
  errorMessage    String?   @map("error_message")
  receivedAt      DateTime  @default(now()) @map("received_at")
  processedAt     DateTime? @map("processed_at")

  restaurant      Restaurant?            @relation(fields: [restaurantId], references: [id], onDelete: SetNull)
  integration     MarketplaceIntegration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  @@unique([provider, externalEventId])
  @@index([restaurantId, provider, receivedAt])
  @@map("marketplace_webhook_events")
}

model MarketplaceMenuMapping {
  id               String    @id @default(uuid())
  restaurantId     String    @map("restaurant_id")
  provider         String
  externalItemId   String    @map("external_item_id")
  externalItemName String?   @map("external_item_name")
  menuItemId       String    @map("menu_item_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  restaurant       Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItem         MenuItem   @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, provider, externalItemId])
  @@index([restaurantId, provider])
  @@index([menuItemId])
  @@map("marketplace_menu_mappings")
}

model MarketplaceStatusSyncJob {
  id                 String    @id @default(uuid())
  restaurantId       String    @map("restaurant_id")
  marketplaceOrderId String    @map("marketplace_order_id")
  provider           String
  externalOrderId    String    @map("external_order_id")
  targetStatus       String    @map("target_status")
  status             String    @default("QUEUED")
  attemptCount       Int       @default(0) @map("attempt_count")
  nextAttemptAt      DateTime  @default(now()) @map("next_attempt_at")
  completedAt        DateTime? @map("completed_at")
  lastError          String?   @map("last_error")
  payload            Json?
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  restaurant         Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  marketplaceOrder   MarketplaceOrder @relation(fields: [marketplaceOrderId], references: [id], onDelete: Cascade)

  @@unique([marketplaceOrderId, targetStatus])
  @@index([restaurantId, status, nextAttemptAt])
  @@map("marketplace_status_sync_jobs")
}

// === PRIMARY CATEGORIES (Top-level nav grouping) ===

model PrimaryCategory {
  id            String   @id @default(uuid())
  restaurantId  String   @map("restaurant_id")
  slug          String   @db.VarChar(50)
  name          String   @db.VarChar(100)
  nameEn        String?  @map("name_en") @db.VarChar(100)
  icon          String?  @db.VarChar(50)
  displayOrder  Int      @default(0) @map("display_order")
  active        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  restaurant     Restaurant     @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuCategories MenuCategory[]

  @@unique([restaurantId, slug])
  @@index([restaurantId])
  @@map("primary_categories")
}

// === MENU CATEGORIES (Subcategories) ===

model MenuCategory {
  id                String   @id @default(uuid())
  restaurantId      String   @map("restaurant_id")
  primaryCategoryId String?  @map("primary_category_id")
  name              String
  nameEn            String?  @map("name_en")
  description       String?
  descriptionEn     String?  @map("description_en")
  displayOrder      Int      @default(0) @map("display_order")
  image             String?
  active            Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  restaurant      Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  primaryCategory PrimaryCategory? @relation(fields: [primaryCategoryId], references: [id], onDelete: SetNull)
  menuItems       MenuItem[]
  stationMappings StationCategoryMapping[]

  @@index([primaryCategoryId])
  @@map("menu_categories")
}

model MenuItem {
  id               String    @id @default(uuid())
  restaurantId     String    @map("restaurant_id")
  categoryId       String    @map("category_id")
  name             String
  nameEn           String?   @map("name_en")
  description      String
  descriptionEn    String?   @map("description_en")
  price            Decimal   @db.Decimal(10, 2)
  cost             Decimal?  @db.Decimal(10, 2)
  image            String?
  available        Boolean   @default(true)
  eightySixed      Boolean   @default(false) @map("eighty_sixed")
  eightySixReason  String?   @map("eighty_six_reason")
  popular          Boolean   @default(false)
  dietary          String[]  @default([])
  displayOrder     Int       @default(0) @map("display_order")
  prepTimeMinutes  Int?      @map("prep_time_minutes")
  taxCategory      String    @default("prepared_food") @map("tax_category")
  aiEstimatedCost  Decimal?  @db.Decimal(10, 2) @map("ai_estimated_cost")
  aiSuggestedPrice Decimal?  @db.Decimal(10, 2) @map("ai_suggested_price")
  aiProfitMargin   Decimal?  @db.Decimal(5, 2) @map("ai_profit_margin")
  aiConfidence     String?   @map("ai_confidence")
  aiLastUpdated    DateTime? @map("ai_last_updated")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  restaurant        Restaurant              @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category          MenuCategory            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  orderItems        OrderItem[]
  modifierGroups    MenuItemModifierGroup[]
  recipeIngredients RecipeIngredient[]
  marketplaceMenuMappings MarketplaceMenuMapping[]
  foodCostRecipes   FoodCostRecipe[]

  @@map("menu_items")
}

// === MODIFIER SYSTEM ===

model ModifierGroup {
  id            String   @id @default(uuid())
  restaurantId  String   @map("restaurant_id")
  name          String
  nameEn        String?  @map("name_en")
  description   String?
  descriptionEn String?  @map("description_en")
  required      Boolean  @default(false)
  multiSelect   Boolean  @default(false) @map("multi_select")
  minSelections Int      @default(0) @map("min_selections")
  maxSelections Int?     @map("max_selections")
  displayOrder  Int      @default(0) @map("display_order")
  active        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  restaurant Restaurant              @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  modifiers  Modifier[]
  menuItems  MenuItemModifierGroup[]

  @@map("modifier_groups")
}

model Modifier {
  id              String   @id @default(uuid())
  modifierGroupId String   @map("modifier_group_id")
  name            String
  nameEn          String?  @map("name_en")
  priceAdjustment Decimal  @default(0) @db.Decimal(10, 2) @map("price_adjustment")
  isDefault       Boolean  @default(false) @map("is_default")
  available       Boolean  @default(true)
  displayOrder    Int      @default(0) @map("display_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  modifierGroup      ModifierGroup       @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  orderItemModifiers OrderItemModifier[]

  @@map("modifiers")
}

model MenuItemModifierGroup {
  id              String @id @default(uuid())
  menuItemId      String @map("menu_item_id")
  modifierGroupId String @map("modifier_group_id")
  displayOrder    Int    @default(0) @map("display_order")

  menuItem      MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifierGroup ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, modifierGroupId])
  @@map("menu_item_modifier_groups")
}

// === TABLE MANAGEMENT ===

model RestaurantTable {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  tableNumber  String   @map("table_number")
  tableName    String?  @map("table_name")
  capacity     Int      @default(4)
  section      String?
  status       String   @default("available")
  posX         Int?     @map("pos_x")
  posY         Int?     @map("pos_y")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orders     Order[]

  @@unique([restaurantId, tableNumber])
  @@map("restaurant_tables")
}

// === CUSTOMERS ===

model Customer {
  id              String    @id @default(uuid())
  restaurantId    String    @map("restaurant_id")
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  email           String?
  phone           String?
  totalOrders     Int       @default(0) @map("total_orders")
  totalSpent      Decimal   @default(0) @db.Decimal(10, 2) @map("total_spent")
  avgOrderValue   Decimal?  @db.Decimal(10, 2) @map("average_order_value")
  lastOrderDate   DateTime? @map("last_order_date")
  loyaltyPoints   Int       @default(0) @map("loyalty_points")
  tags            String[]  @default([])
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  loyaltyTier         String    @default("bronze") @map("loyalty_tier")
  totalPointsEarned   Int       @default(0) @map("total_points_earned")
  totalPointsRedeemed Int       @default(0) @map("total_points_redeemed")

  restaurant           Restaurant           @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orders               Order[]
  reservations         Reservation[]
  loyaltyTransactions  LoyaltyTransaction[]

  @@unique([restaurantId, phone])
  @@map("customers")
}

// === ORDERS ===

model Order {
  id                    String    @id @default(uuid())
  restaurantId          String    @map("restaurant_id")
  customerId            String?   @map("customer_id")
  tableId               String?   @map("table_id")
  serverId              String?   @map("server_id")
  sourceDeviceId        String?   @map("source_device_id")
  orderNumber           String    @unique @map("order_number")
  orderType             String    @map("order_type")
  orderSource           String    @default("online") @map("order_source")
  status                String    @default("pending")
  subtotal              Decimal   @db.Decimal(10, 2)
  tax                   Decimal   @db.Decimal(10, 2)
  tip                   Decimal   @default(0) @db.Decimal(10, 2)
  discount              Decimal   @default(0) @db.Decimal(10, 2)
  deliveryFee           Decimal   @default(0) @db.Decimal(10, 2) @map("delivery_fee")
  total                 Decimal   @db.Decimal(10, 2)
  paymentMethod         String?   @map("payment_method")
  paymentStatus         String    @default("pending") @map("payment_status")
  stripePaymentIntentId String?   @map("stripe_payment_intent_id")
  paypalOrderId         String?   @map("paypal_order_id")
  paypalCaptureId       String?   @map("paypal_capture_id")
  specialInstructions   String?   @map("special_instructions")
  deliveryAddress       String?   @map("delivery_address")
  deliveryLat           Decimal?  @db.Decimal(10, 7) @map("delivery_lat")
  deliveryLng           Decimal?  @db.Decimal(10, 7) @map("delivery_lng")
  deliveryProvider      String?   @map("delivery_provider")
  deliveryExternalId    String?   @map("delivery_external_id")
  deliveryTrackingUrl   String?   @map("delivery_tracking_url")
  dispatchStatus        String?   @map("dispatch_status")
  throttleState         String    @default("NONE") @map("throttle_state")
  throttleReason        String?   @map("throttle_reason")
  throttleHeldAt        DateTime? @map("throttle_held_at")
  throttleReleasedAt    DateTime? @map("throttle_released_at")
  throttleSource        String?   @map("throttle_source")
  throttleReleaseReason String?   @map("throttle_release_reason")
  scheduledTime         DateTime? @map("scheduled_time")

  // Structured delivery address
  deliveryAddress2      String?   @map("delivery_address_2")
  deliveryCity          String?   @map("delivery_city")
  deliveryStateUs       String?   @map("delivery_state_us")
  deliveryZip           String?   @map("delivery_zip")
  deliveryNotes         String?   @map("delivery_notes")
  deliveryStatus        String?   @map("delivery_status")
  deliveryEstimatedAt   DateTime? @map("delivery_estimated_at")
  dispatchedAt          DateTime? @map("dispatched_at")
  deliveredAt           DateTime? @map("delivered_at")

  // Curbside
  vehicleDescription    String?   @map("vehicle_description")
  arrivalNotified       Boolean   @default(false) @map("arrival_notified")

  // Catering
  eventDate             DateTime? @map("event_date")
  eventTime             String?   @map("event_time")
  headcount             Int?
  eventType             String?   @map("event_type")
  setupRequired         Boolean   @default(false) @map("setup_required")
  depositAmount         Decimal?  @db.Decimal(10, 2) @map("deposit_amount")
  depositPaid           Boolean   @default(false) @map("deposit_paid")
  cateringInstructions  String?   @map("catering_instructions")

  // Approval (catering)
  approvalStatus        String?   @map("approval_status")
  approvedBy            String?   @map("approved_by")
  approvedAt            DateTime? @map("approved_at")
  sentToKitchenAt       DateTime? @map("sent_to_kitchen_at")
  confirmedAt           DateTime? @map("confirmed_at")
  preparingAt           DateTime? @map("preparing_at")
  readyAt               DateTime? @map("ready_at")
  completedAt           DateTime? @map("completed_at")
  cancelledAt           DateTime? @map("cancelled_at")
  cancellationReason    String?   @map("cancellation_reason")
  cancelledBy           String?   @map("cancelled_by")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  loyaltyPointsEarned   Int     @default(0) @map("loyalty_points_earned")
  loyaltyPointsRedeemed Int     @default(0) @map("loyalty_points_redeemed")

  restaurant           Restaurant           @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  customer             Customer?            @relation(fields: [customerId], references: [id], onDelete: SetNull)
  table                RestaurantTable?     @relation(fields: [tableId], references: [id], onDelete: SetNull)
  orderItems           OrderItem[]
  checks               OrderCheck[]
  statusHistory        OrderStatusHistory[]
  marketplaceOrder     MarketplaceOrder?
  printJobs            PrintJob[]
  loyaltyTransactions  LoyaltyTransaction[]

  @@map("orders")
}

model OrderItem {
  id                  String   @id @default(uuid())
  orderId             String   @map("order_id")
  menuItemId          String?  @map("menu_item_id")
  menuItemName        String   @map("menu_item_name")
  quantity            Int
  unitPrice           Decimal  @db.Decimal(10, 2) @map("unit_price")
  modifiersPrice      Decimal  @default(0) @db.Decimal(10, 2) @map("modifiers_price")
  totalPrice          Decimal  @db.Decimal(10, 2) @map("total_price")
  specialInstructions String?  @map("special_instructions")
  status              String   @default("pending")
  fulfillmentStatus   String   @default("NEW") @map("fulfillment_status")
  courseGuid          String?  @map("course_guid")
  courseName          String?  @map("course_name")
  courseSortOrder     Int?     @map("course_sort_order")
  courseFireStatus    String?  @map("course_fire_status")
  courseFiredAt       DateTime? @map("course_fired_at")
  courseReadyAt       DateTime? @map("course_ready_at")
  sentToKitchenAt     DateTime? @map("sent_to_kitchen_at")
  completedAt         DateTime? @map("completed_at")
  createdAt           DateTime @default(now()) @map("created_at")

  order     Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem  MenuItem?           @relation(fields: [menuItemId], references: [id], onDelete: SetNull)
  modifiers OrderItemModifier[]

  @@map("order_items")
}

model OrderItemModifier {
  id              String  @id @default(uuid())
  orderItemId     String  @map("order_item_id")
  modifierId      String? @map("modifier_id")
  modifierName    String  @map("modifier_name")
  priceAdjustment Decimal @db.Decimal(10, 2) @map("price_adjustment")

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifier  Modifier? @relation(fields: [modifierId], references: [id], onDelete: SetNull)

  @@map("order_item_modifiers")
}

// === CHECK MANAGEMENT (POS) ===

model OrderCheck {
  id             String    @id @default(uuid())
  orderId        String    @map("order_id")
  restaurantId   String    @map("restaurant_id")
  displayNumber  Int       @map("display_number")
  paymentStatus  String    @default("OPEN") @map("payment_status")
  subtotal       Decimal   @default(0) @db.Decimal(10, 2)
  tax            Decimal   @default(0) @db.Decimal(10, 2)
  tip            Decimal   @default(0) @db.Decimal(10, 2)
  total          Decimal   @default(0) @db.Decimal(10, 2)
  tabName        String?   @map("tab_name")
  tabOpenedAt    DateTime? @map("tab_opened_at")
  tabClosedAt    DateTime? @map("tab_closed_at")
  preauthId      String?   @map("preauth_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  order        Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  items        CheckItem[]
  discounts    CheckDiscount[]
  voidedItems  CheckVoidedItem[]

  @@index([orderId])
  @@index([restaurantId])
  @@map("order_checks")
}

model CheckItem {
  id                  String    @id @default(uuid())
  checkId             String    @map("check_id")
  orderId             String    @map("order_id")
  menuItemId          String?   @map("menu_item_id")
  menuItemName        String    @map("menu_item_name")
  quantity            Int
  unitPrice           Decimal   @db.Decimal(10, 2) @map("unit_price")
  modifiersPrice      Decimal   @default(0) @db.Decimal(10, 2) @map("modifiers_price")
  totalPrice          Decimal   @db.Decimal(10, 2) @map("total_price")
  specialInstructions String?   @map("special_instructions")
  seatNumber          Int?      @map("seat_number")
  fulfillmentStatus   String    @default("NEW") @map("fulfillment_status")
  courseGuid          String?   @map("course_guid")
  isComped            Boolean   @default(false) @map("is_comped")
  compReason          String?   @map("comp_reason")
  compBy              String?   @map("comp_by")
  compApprovedBy      String?   @map("comp_approved_by")
  compAt              DateTime? @map("comp_at")
  createdAt           DateTime  @default(now()) @map("created_at")

  check     OrderCheck          @relation(fields: [checkId], references: [id], onDelete: Cascade)
  modifiers CheckItemModifier[]

  @@index([checkId])
  @@index([orderId])
  @@map("check_items")
}

model CheckItemModifier {
  id              String  @id @default(uuid())
  checkItemId     String  @map("check_item_id")
  modifierId      String? @map("modifier_id")
  modifierName    String  @map("modifier_name")
  priceAdjustment Decimal @db.Decimal(10, 2) @map("price_adjustment")

  checkItem CheckItem @relation(fields: [checkItemId], references: [id], onDelete: Cascade)

  @@map("check_item_modifiers")
}

model CheckDiscount {
  id         String  @id @default(uuid())
  checkId    String  @map("check_id")
  orderId    String  @map("order_id")
  type       String  // percentage, flat, comp
  value      Decimal @db.Decimal(10, 2)
  reason     String
  appliedBy  String  @map("applied_by")
  approvedBy String? @map("approved_by")
  createdAt  DateTime @default(now()) @map("created_at")

  check OrderCheck @relation(fields: [checkId], references: [id], onDelete: Cascade)

  @@index([checkId])
  @@map("check_discounts")
}

model CheckVoidedItem {
  id              String   @id @default(uuid())
  checkId         String   @map("check_id")
  checkItemId     String   @map("check_item_id")
  orderId         String   @map("order_id")
  menuItemName    String   @map("menu_item_name")
  quantity        Int
  unitPrice       Decimal  @db.Decimal(10, 2) @map("unit_price")
  totalPrice      Decimal  @db.Decimal(10, 2) @map("total_price")
  voidReason      String   @map("void_reason")
  voidedBy        String   @map("voided_by")
  managerApproval String?  @map("manager_approval")
  voidedAt        DateTime @default(now()) @map("voided_at")

  check OrderCheck @relation(fields: [checkId], references: [id], onDelete: Cascade)

  @@index([checkId])
  @@map("check_voided_items")
}

// === RESERVATIONS ===

model Reservation {
  id               String    @id @default(uuid())
  restaurantId     String    @map("restaurant_id")
  customerId       String?   @map("customer_id")
  customerName     String    @map("customer_name")
  customerPhone    String    @map("customer_phone")
  customerEmail    String?   @map("customer_email")
  partySize        Int       @map("party_size")
  reservationTime  DateTime  @map("reservation_time")
  tableNumber      String?   @map("table_number")
  status           String    @default("pending")
  specialRequests  String?   @map("special_requests")
  confirmationSent Boolean   @default(false) @map("confirmation_sent")
  reminderSent     Boolean   @default(false) @map("reminder_sent")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  customer   Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@map("reservations")
}

// === TAX JURISDICTIONS (AI-populated lookup table) ===

model TaxJurisdiction {
  id           String    @id @default(uuid())
  zipCode      String    @map("zip_code")
  city         String?
  county       String?
  state        String    @default("FL")
  taxRate      Decimal   @db.Decimal(5, 4) @map("tax_rate")
  breakdown    Json?
  source       String    @default("ai")
  verifiedAt   DateTime? @map("verified_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@unique([zipCode, state])
  @@map("tax_jurisdictions")
}

// === ORDER STATUS TRACKING ===

model OrderStatusHistory {
  id         String   @id @default(uuid())
  orderId    String   @map("order_id")
  fromStatus String?  @map("from_status")
  toStatus   String   @map("to_status")
  changedBy  String?  @map("changed_by")
  note       String?
  createdAt  DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_status_history")
}

// === INVENTORY MANAGEMENT ===

model InventoryItem {
  id            String    @id @default(uuid())
  restaurantId  String    @map("restaurant_id")
  name          String    @db.VarChar(255)
  nameEn        String?   @map("name_en") @db.VarChar(255)
  unit          String    @default("units") @db.VarChar(50)
  currentStock  Decimal   @default(0) @db.Decimal(10, 2) @map("current_stock")
  minStock      Decimal   @default(0) @db.Decimal(10, 2) @map("min_stock")
  maxStock      Decimal   @default(100) @db.Decimal(10, 2) @map("max_stock")
  costPerUnit   Decimal   @default(0) @db.Decimal(10, 4) @map("cost_per_unit")
  supplier      String?   @db.VarChar(255)
  category      String    @default("general") @db.VarChar(100)
  lastRestocked DateTime? @map("last_restocked")
  lastCountDate DateTime? @map("last_count_date")
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  restaurant        Restaurant         @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  logs              InventoryLog[]
  recipeIngredients RecipeIngredient[]

  @@index([restaurantId])
  @@index([restaurantId, category])
  @@map("inventory_items")
}

model InventoryLog {
  id              String   @id @default(uuid())
  inventoryItemId String   @map("inventory_item_id")
  previousStock   Decimal  @db.Decimal(10, 2) @map("previous_stock")
  newStock        Decimal  @db.Decimal(10, 2) @map("new_stock")
  changeAmount    Decimal  @db.Decimal(10, 2) @map("change_amount")
  reason          String?  @db.VarChar(255)
  createdBy       String?  @map("created_by") @db.VarChar(255)
  createdAt       DateTime @default(now()) @map("created_at")

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([inventoryItemId])
  @@index([createdAt])
  @@map("inventory_logs")
}

model RecipeIngredient {
  id              String   @id @default(uuid())
  menuItemId      String   @map("menu_item_id")
  inventoryItemId String   @map("inventory_item_id")
  quantity        Decimal  @db.Decimal(10, 4)
  unit            String   @db.VarChar(50)
  notes           String?  @db.VarChar(255)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  menuItem      MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, inventoryItemId])
  @@index([menuItemId])
  @@index([inventoryItemId])
  @@map("recipe_ingredients")
}

// === AUTHENTICATION & AUTHORIZATION ===

model RestaurantGroup {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  logo        String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users       User[]
  restaurants Restaurant[]
  locationGroups LocationGroup[]
  menuSyncLogs   MenuSyncLog[]

  @@map("restaurant_groups")
}

model User {
  id                String    @id @default(uuid())
  restaurantGroupId String?   @map("restaurant_group_id")
  email             String    @unique
  passwordHash      String    @map("password_hash")
  firstName         String?   @map("first_name")
  lastName          String?   @map("last_name")
  role              String    @default("staff") // super_admin, owner, manager, staff
  isActive          Boolean   @default(true) @map("is_active")
  lastLoginAt       DateTime? @map("last_login_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  restaurantGroup  RestaurantGroup?       @relation(fields: [restaurantGroupId], references: [id], onDelete: SetNull)
  restaurantAccess UserRestaurantAccess[]
  sessions         UserSession[]

  @@index([restaurantGroupId])
  @@map("users")
}

model UserRestaurantAccess {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  restaurantId String   @map("restaurant_id")
  role         String   @default("staff") // owner, manager, staff
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@index([restaurantId])
  @@map("user_restaurant_access")
}

model UserSession {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  token      String   @unique
  deviceInfo String?  @map("device_info")
  ipAddress  String?  @map("ip_address")
  isActive   Boolean  @default(true) @map("is_active")
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_sessions")
}

model StaffPin {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  pin          String   // hashed 4-6 digit PIN
  name         String   // display name
  role         String   @default("staff")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  shifts             Shift[]
  timeEntries        TimeEntry[]
  availability       StaffAvailability[]
  swapRequestsMade   SwapRequest[]       @relation("SwapRequestor")
  timecardEdits      TimecardEditRequest[]

  @@index([restaurantId])
  @@map("staff_pins")
}

model Shift {
  id            String   @id @default(uuid())
  restaurantId  String   @map("restaurant_id")
  staffPinId    String   @map("staff_pin_id")
  date          DateTime @db.Date
  startTime     String   @db.VarChar(5)   // "HH:mm" 24h
  endTime       String   @db.VarChar(5)   // "HH:mm" 24h
  position      String   @default("server")
  breakMinutes  Int      @default(0) @map("break_minutes")
  notes         String?
  isPublished   Boolean  @default(false) @map("is_published")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  staffPin      StaffPin      @relation(fields: [staffPinId], references: [id], onDelete: Cascade)
  swapRequests  SwapRequest[]
  @@index([restaurantId, date])
  @@index([staffPinId])
  @@map("shifts")
}

model TimeEntry {
  id            String    @id @default(uuid())
  restaurantId  String    @map("restaurant_id")
  staffPinId    String    @map("staff_pin_id")
  shiftId       String?   @map("shift_id")
  clockIn       DateTime  @map("clock_in")
  clockOut      DateTime? @map("clock_out")
  breakMinutes  Int       @default(0) @map("break_minutes")
  notes         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  staffPin      StaffPin  @relation(fields: [staffPinId], references: [id], onDelete: Cascade)
  editRequests  TimecardEditRequest[]
  @@index([restaurantId, clockIn])
  @@index([staffPinId])
  @@map("time_entries")
}

model LaborTarget {
  id            String   @id @default(uuid())
  restaurantId  String   @map("restaurant_id")
  dayOfWeek     Int      // 0=Sunday .. 6=Saturday
  targetPercent Decimal  @db.Decimal(5,2) @map("target_percent")
  targetCost    Decimal? @db.Decimal(10,2) @map("target_cost")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  @@unique([restaurantId, dayOfWeek])
  @@map("labor_targets")
}

model StaffAvailability {
  id             String   @id @default(uuid())
  restaurantId   String   @map("restaurant_id")
  staffPinId     String   @map("staff_pin_id")
  dayOfWeek      Int      @map("day_of_week") // 0=Sunday .. 6=Saturday
  isAvailable    Boolean  @default(true) @map("is_available")
  preferredStart String?  @db.VarChar(5) @map("preferred_start") // "HH:mm"
  preferredEnd   String?  @db.VarChar(5) @map("preferred_end")   // "HH:mm"
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  staffPin       StaffPin @relation(fields: [staffPinId], references: [id], onDelete: Cascade)

  @@unique([staffPinId, dayOfWeek])
  @@index([restaurantId])
  @@map("staff_availability")
}

model SwapRequest {
  id             String    @id @default(uuid())
  restaurantId   String    @map("restaurant_id")
  shiftId        String    @map("shift_id")
  requestorPinId String    @map("requestor_pin_id")
  targetPinId    String?   @map("target_pin_id")
  reason         String
  status         String    @default("pending") // pending | approved | rejected
  respondedAt    DateTime? @map("responded_at")
  respondedBy    String?   @map("responded_by")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  shift          Shift     @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  requestor      StaffPin  @relation("SwapRequestor", fields: [requestorPinId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([requestorPinId])
  @@map("swap_requests")
}

model StaffNotification {
  id              String   @id @default(uuid())
  restaurantId    String   @map("restaurant_id")
  recipientPinId  String   @map("recipient_pin_id")
  type            String   // schedule_published | shift_changed | swap_approved | swap_rejected | timecard_approved | timecard_rejected | announcement
  title           String
  message         String
  isRead          Boolean  @default(false) @map("is_read")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([restaurantId])
  @@index([recipientPinId])
  @@index([recipientPinId, isRead])
  @@map("staff_notifications")
}

model WorkweekConfig {
  id                     String   @id @default(uuid())
  restaurantId           String   @unique @map("restaurant_id")
  weekStartDay           Int      @default(0) @map("week_start_day") // 0=Sunday .. 6=Saturday
  dayStartTime           String   @default("04:00") @db.VarChar(5) @map("day_start_time") // "HH:mm" 24h
  overtimeThresholdHours Decimal  @default(40) @db.Decimal(5,2) @map("overtime_threshold_hours")
  overtimeMultiplier     Decimal  @default(1.5) @db.Decimal(3,2) @map("overtime_multiplier")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
  @@map("workweek_configs")
}

model TimecardEditRequest {
  id            String    @id @default(uuid())
  restaurantId  String    @map("restaurant_id")
  timeEntryId   String    @map("time_entry_id")
  staffPinId    String    @map("staff_pin_id")
  editType      String    @map("edit_type") // clock_in_time | clock_out_time | break_minutes
  originalValue String    @map("original_value")
  newValue      String    @map("new_value")
  reason        String
  status        String    @default("pending") // pending | approved | denied
  respondedBy   String?   @map("responded_by")
  respondedAt   DateTime? @map("responded_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  timeEntry     TimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  staffPin      StaffPin  @relation(fields: [staffPinId], references: [id], onDelete: Cascade)

  @@index([restaurantId, status])
  @@index([staffPinId])
  @@map("timecard_edit_requests")
}

model ScheduleTemplate {
  id            String          @id @default(uuid())
  restaurantId  String          @map("restaurant_id")
  name          String
  createdBy     String          @map("created_by")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  shifts        TemplateShift[]

  @@index([restaurantId])
  @@map("schedule_templates")
}

model TemplateShift {
  id              String           @id @default(uuid())
  templateId      String           @map("template_id")
  staffPinId      String           @map("staff_pin_id")
  staffName       String           @map("staff_name")
  dayOfWeek       Int              @map("day_of_week") // 0=Sunday .. 6=Saturday
  startTime       String           @db.VarChar(5) @map("start_time")
  endTime         String           @db.VarChar(5) @map("end_time")
  position        String           @default("server")
  breakMinutes    Int              @default(0) @map("break_minutes")
  template        ScheduleTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("template_shifts")
}

model Station {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  name         String   // e.g., "Grill", "Fry", "Cold", "Expo"
  displayOrder Int      @default(0) @map("display_order")
  isExpo       Boolean  @default(false) @map("is_expo")
  color        String?
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  categoryMappings StationCategoryMapping[]

  @@unique([restaurantId, name])
  @@index([restaurantId])
  @@map("stations")
}

model StationCategoryMapping {
  id           String   @id @default(uuid())
  stationId    String   @map("station_id")
  categoryId   String   @map("category_id")
  restaurantId String   @map("restaurant_id")
  createdAt    DateTime @default(now()) @map("created_at")

  station  Station      @relation(fields: [stationId], references: [id], onDelete: Cascade)
  category MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([stationId, categoryId])
  @@index([restaurantId])
  @@index([categoryId])
  @@map("station_category_mappings")
}

model Device {
  id             String    @id @default(uuid())
  restaurantId   String    @map("restaurant_id")
  locationId     String?   @map("location_id")
  deviceCode     String?   @unique @map("device_code")
  deviceName     String    @map("device_name")
  deviceType     String    @map("device_type") // 'pos_terminal', 'kds_station', 'kiosk', 'order_pad', 'printer_station'
  posMode        String?   @map("pos_mode") // 'full_service', 'quick_service', 'bar', 'retail', 'services', 'bookings', 'standard'
  modeId         String?   @map("mode_id")
  status         String    @default("pending") // 'pending', 'active', 'revoked'
  hardwareInfo   Json?     @map("hardware_info") // {platform, osVersion, appVersion, screenSize, serialNumber}
  lastSeenAt     DateTime? @map("last_seen_at")
  pairedAt       DateTime? @map("paired_at")
  expiresAt      DateTime? @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  restaurant     Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  mode           DeviceMode?     @relation(fields: [modeId], references: [id], onDelete: SetNull)
  peripherals    PeripheralDevice[]

  @@index([restaurantId])
  @@index([deviceCode])
  @@map("devices")
}

model DeviceMode {
  id             String   @id @default(uuid())
  restaurantId   String   @map("restaurant_id")
  name           String
  deviceType     String   @map("device_type") // 'pos_terminal', 'kds_station', 'kiosk', 'order_pad', 'printer_station'
  isDefault      Boolean  @default(false) @map("is_default")
  settings       Json     // DeviceModeSettings: {checkout, receipt, security, display}
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  restaurant     Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  devices        Device[]

  @@unique([restaurantId, name])
  @@index([restaurantId])
  @@map("device_modes")
}

model PrinterProfile {
  id             String   @id @default(uuid())
  restaurantId   String   @map("restaurant_id")
  name           String
  isDefault      Boolean  @default(false) @map("is_default")
  routingRules   Json     // PrintRoutingRule[]: [{jobType, printerId, copies, enabled}]
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  restaurant     Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, name])
  @@index([restaurantId])
  @@map("printer_profiles")
}

model PeripheralDevice {
  id               String    @id @default(uuid())
  restaurantId     String    @map("restaurant_id")
  parentDeviceId   String    @map("parent_device_id")
  type             String    // 'cash_drawer', 'barcode_scanner', 'card_reader', 'customer_display', 'scale'
  name             String
  connectionType   String    @map("connection_type") // 'usb', 'bluetooth', 'network'
  status           String    @default("disconnected") // 'connected', 'disconnected', 'error'
  lastSeenAt       DateTime? @map("last_seen_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  restaurant       Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  parentDevice     Device     @relation(fields: [parentDeviceId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([parentDeviceId])
  @@map("peripheral_devices")
}

model KioskProfile {
  id                   String   @id @default(uuid())
  restaurantId         String   @map("restaurant_id")
  name                 String
  posMode              String   @map("pos_mode")
  welcomeMessage       String   @default("Welcome!") @map("welcome_message")
  showImages           Boolean  @default(true) @map("show_images")
  enabledCategories    Json     @default("[]") @map("enabled_categories") // string[]
  requireNameForOrder  Boolean  @default(false) @map("require_name_for_order")
  maxIdleSeconds       Int      @default(120) @map("max_idle_seconds")
  enableAccessibility  Boolean  @default(false) @map("enable_accessibility")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  restaurant           Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, name])
  @@index([restaurantId])
  @@map("kiosk_profiles")
}

// === RECEIPT PRINTING ===

model Printer {
  id           String    @id @default(uuid())
  restaurantId String    @map("restaurant_id")
  name         String
  model        String    // 'Star mC-Print3', 'Star mC-Print2', 'Star TSP654II', 'Star TSP743II'
  macAddress   String    @unique @map("mac_address")
  ipAddress    String?   @map("ip_address")
  cloudPrntId  String    @unique @default(uuid()) @map("cloudprnt_id")
  registrationToken String @unique @default(uuid()) @map("registration_token")
  printWidth   Int       @default(48) @map("print_width")
  isDefault    Boolean   @default(false) @map("is_default")
  isActive     Boolean   @default(true) @map("is_active")
  lastPollAt   DateTime? @map("last_poll_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  printJobs  PrintJob[]

  @@index([restaurantId])
  @@index([macAddress])
  @@index([restaurantId, isDefault])
  @@map("printers")
}

model PrintJob {
  id            String    @id @default(uuid())
  orderId       String    @map("order_id")
  printerId     String    @map("printer_id")
  status        String    @default("pending") // 'pending' | 'printing' | 'completed' | 'failed'
  jobData       Json      @map("job_data")
  attemptCount  Int       @default(0) @map("attempt_count")
  errorMessage  String?   @map("error_message")
  createdAt     DateTime  @default(now()) @map("created_at")
  completedAt   DateTime? @map("completed_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  printer Printer @relation(fields: [printerId], references: [id], onDelete: Cascade)

  @@index([printerId, status])
  @@index([orderId])
  @@index([status, createdAt])
  @@map("print_jobs")
}

// === LOYALTY PROGRAM ===

model LoyaltyTransaction {
  id            String   @id @default(uuid())
  restaurantId  String   @map("restaurant_id")
  customerId    String   @map("customer_id")
  orderId       String?  @map("order_id")
  type          String   // 'earn' | 'redeem' | 'adjustment' | 'expire' | 'reversal'
  points        Int      // positive for earn, negative for redeem/reversal
  balanceAfter  Int      @map("balance_after")
  description   String?
  createdAt     DateTime @default(now()) @map("created_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  customer   Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  order      Order?     @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([restaurantId])
  @@map("loyalty_transactions")
}

model LoyaltyReward {
  id            String   @id @default(uuid())
  restaurantId  String   @map("restaurant_id")
  name          String
  description   String?
  pointsCost    Int      @map("points_cost")
  discountType  String   @map("discount_type")  // 'fixed' | 'percentage'
  discountValue Decimal  @db.Decimal(10, 2) @map("discount_value")
  minTier       String   @default("bronze") @map("min_tier")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@map("loyalty_rewards")
}

model RestaurantLoyaltyConfig {
  id                   String   @id @default(uuid())
  restaurantId         String   @unique @map("restaurant_id")
  enabled              Boolean  @default(false)
  pointsPerDollar      Int      @default(1) @map("points_per_dollar")
  pointsRedemptionRate Decimal  @db.Decimal(5, 2) @default(0.01) @map("points_redemption_rate")
  tierSilverMin        Int      @default(500) @map("tier_silver_min")
  tierGoldMin          Int      @default(2000) @map("tier_gold_min")
  tierPlatinumMin      Int      @default(5000) @map("tier_platinum_min")
  silverMultiplier     Decimal  @db.Decimal(3, 2) @default(1.25) @map("silver_multiplier")
  goldMultiplier       Decimal  @db.Decimal(3, 2) @default(1.50) @map("gold_multiplier")
  platinumMultiplier   Decimal  @db.Decimal(3, 2) @default(2.00) @map("platinum_multiplier")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("restaurant_loyalty_config")
}

// === GIFT CARDS ===

model GiftCard {
  id             String    @id @default(uuid())
  restaurantId   String    @map("restaurant_id")
  code           String    @unique
  type           String    // physical / digital
  initialBalance Decimal   @db.Decimal(10, 2) @map("initial_balance")
  currentBalance Decimal   @db.Decimal(10, 2) @map("current_balance")
  status         String    @default("active") // active / redeemed / disabled
  purchasedBy    String?   @map("purchased_by")
  recipientName  String?   @map("recipient_name")
  recipientEmail String?   @map("recipient_email")
  expiresAt      DateTime? @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  restaurant  Restaurant          @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  redemptions GiftCardRedemption[]

  @@index([restaurantId])
  @@map("gift_cards")
}

model GiftCardRedemption {
  id         String   @id @default(uuid())
  giftCardId String   @map("gift_card_id")
  orderId    String?  @map("order_id")
  amount     Decimal  @db.Decimal(10, 2)
  redeemedBy String?  @map("redeemed_by")
  createdAt  DateTime @default(now()) @map("created_at")

  giftCard GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)

  @@index([giftCardId])
  @@map("gift_card_redemptions")
}

// === INVOICING ===

model Invoice {
  id             String    @id @default(uuid())
  restaurantId   String    @map("restaurant_id")
  invoiceNumber  String    @unique @map("invoice_number")
  customerId     String?   @map("customer_id")
  customerName   String    @map("customer_name")
  customerEmail  String    @map("customer_email")
  houseAccountId String?   @map("house_account_id")
  status         String    @default("draft") // draft / sent / paid / overdue / cancelled
  subtotal       Decimal   @db.Decimal(10, 2)
  tax            Decimal   @db.Decimal(10, 2)
  total          Decimal   @db.Decimal(10, 2)
  paidAmount     Decimal   @default(0) @db.Decimal(10, 2) @map("paid_amount")
  dueDate        DateTime  @map("due_date")
  notes          String?
  sentAt         DateTime? @map("sent_at")
  paidAt         DateTime? @map("paid_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  restaurant   Restaurant        @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  houseAccount HouseAccount?     @relation(fields: [houseAccountId], references: [id], onDelete: SetNull)
  lineItems    InvoiceLineItem[]

  @@index([restaurantId])
  @@index([houseAccountId])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String  @id @default(uuid())
  invoiceId   String  @map("invoice_id")
  description String
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2) @map("unit_price")
  total       Decimal @db.Decimal(10, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_line_items")
}

model HouseAccount {
  id             String   @id @default(uuid())
  restaurantId   String   @map("restaurant_id")
  name           String
  contactName    String   @map("contact_name")
  contactEmail   String   @map("contact_email")
  creditLimit    Decimal  @db.Decimal(10, 2) @map("credit_limit")
  currentBalance Decimal  @default(0) @db.Decimal(10, 2) @map("current_balance")
  status         String   @default("active") // active / suspended / closed
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  invoices   Invoice[]

  @@index([restaurantId])
  @@map("house_accounts")
}

// === MARKETING CAMPAIGNS ===

model Campaign {
  id                   String    @id @default(uuid())
  restaurantId         String    @map("restaurant_id")
  name                 String
  channel              String    // email / sms / both
  type                 String    // promotion / announcement / loyalty / re-engagement / event
  status               String    @default("draft") // draft / scheduled / sent / cancelled
  subject              String?
  body                 String
  audienceSegment      String?   @map("audience_segment")
  audienceLoyaltyTier  String?   @map("audience_loyalty_tier")
  estimatedRecipients  Int?      @map("estimated_recipients")
  scheduledAt          DateTime? @map("scheduled_at")
  sentAt               DateTime? @map("sent_at")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  restaurant  Restaurant           @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  performance CampaignPerformance?

  @@index([restaurantId])
  @@map("campaigns")
}

model CampaignPerformance {
  id         String   @id @default(uuid())
  campaignId String   @unique @map("campaign_id")
  sent       Int      @default(0)
  delivered  Int      @default(0)
  opened     Int      @default(0)
  clicked    Int      @default(0)
  converted  Int      @default(0)
  revenue    Decimal  @default(0) @db.Decimal(10, 2)
  updatedAt  DateTime @updatedAt @map("updated_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("campaign_performances")
}

// === COMBOS / BUNDLES ===

model Combo {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  name         String
  description  String?
  comboPrice   Decimal  @db.Decimal(10, 2) @map("combo_price")
  isActive     Boolean  @default(true) @map("is_active")
  items        Json     // Array of {menuItemId, menuItemName, quantity, required}
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@map("combos")
}

// === AI CREDENTIALS & USAGE ===

model RestaurantAiCredentials {
  id              String   @id @default(uuid())
  restaurantId    String   @unique @map("restaurant_id")
  encryptedApiKey String   @map("encrypted_api_key")
  encryptionIv    String   @map("encryption_iv")
  encryptionTag   String   @map("encryption_tag")
  keyLastFour     String?  @map("key_last_four")
  isValid         Boolean  @default(false) @map("is_valid")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("restaurant_ai_credentials")
}

model AiUsageLog {
  id                 String   @id @default(uuid())
  restaurantId       String   @map("restaurant_id")
  featureKey         String   @map("feature_key")
  inputTokens        Int      @map("input_tokens")
  outputTokens       Int      @map("output_tokens")
  estimatedCostCents Int      @map("estimated_cost_cents")
  calledAt           DateTime @default(now()) @map("called_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId, calledAt])
  @@index([restaurantId, featureKey])
  @@map("ai_usage_logs")
}

// === FOOD COST / AP AUTOMATION (T5-07) ===

model Vendor {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  name         String
  contactName  String?  @map("contact_name")
  contactEmail String?  @map("contact_email")
  phone        String?
  address      String?
  notes        String?
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  restaurant       Restaurant        @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  purchaseInvoices PurchaseInvoice[]

  @@index([restaurantId])
  @@map("vendors")
}

model PurchaseInvoice {
  id              String    @id @default(uuid())
  restaurantId    String    @map("restaurant_id")
  vendorId        String    @map("vendor_id")
  invoiceNumber   String    @map("invoice_number")
  invoiceDate     DateTime  @map("invoice_date")
  totalAmount     Decimal   @db.Decimal(10, 2) @map("total_amount")
  status          String    @default("pending_review") // pending_review / approved / paid
  imageUrl        String?   @map("image_url")
  ocrProcessedAt  DateTime? @map("ocr_processed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  restaurant Restaurant          @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  vendor     Vendor               @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  lineItems  PurchaseLineItem[]

  @@unique([restaurantId, invoiceNumber])
  @@index([restaurantId])
  @@index([vendorId])
  @@map("purchase_invoices")
}

model PurchaseLineItem {
  id                   String   @id @default(uuid())
  invoiceId            String   @map("invoice_id")
  ingredientName       String   @map("ingredient_name")
  quantity             Decimal  @db.Decimal(10, 4)
  unit                 String
  unitCost             Decimal  @db.Decimal(10, 4) @map("unit_cost")
  totalCost            Decimal  @db.Decimal(10, 2) @map("total_cost")
  normalizedIngredient String?  @map("normalized_ingredient")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  invoice PurchaseInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("purchase_line_items")
}

model FoodCostRecipe {
  id           String   @id @default(uuid())
  menuItemId   String   @map("menu_item_id")
  restaurantId String   @map("restaurant_id")
  name         String
  yieldQty     Decimal  @db.Decimal(10, 2) @map("yield_qty")
  yieldUnit    String   @map("yield_unit")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  menuItem    MenuItem                    @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  restaurant  Restaurant                  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  ingredients FoodCostRecipeIngredient[]

  @@index([restaurantId])
  @@index([menuItemId])
  @@map("food_cost_recipes")
}

model FoodCostRecipeIngredient {
  id               String   @id @default(uuid())
  recipeId         String   @map("recipe_id")
  ingredientName   String   @map("ingredient_name")
  quantity         Decimal  @db.Decimal(10, 4)
  unit             String
  estimatedUnitCost Decimal @db.Decimal(10, 4) @map("estimated_unit_cost")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  recipe FoodCostRecipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("food_cost_recipe_ingredients")
}

// === MULTI-LOCATION MANAGEMENT (T5-08) ===

model LocationGroup {
  id                String   @id @default(uuid())
  restaurantGroupId String   @map("restaurant_group_id")
  name              String
  description       String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  restaurantGroup RestaurantGroup       @relation(fields: [restaurantGroupId], references: [id], onDelete: Cascade)
  members         LocationGroupMember[]

  @@index([restaurantGroupId])
  @@map("location_groups")
}

model LocationGroupMember {
  id              String   @id @default(uuid())
  locationGroupId String   @map("location_group_id")
  restaurantId    String   @map("restaurant_id")
  createdAt       DateTime @default(now()) @map("created_at")

  locationGroup LocationGroup @relation(fields: [locationGroupId], references: [id], onDelete: Cascade)
  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([locationGroupId, restaurantId])
  @@index([restaurantId])
  @@map("location_group_members")
}

model MenuSyncLog {
  id                  String   @id @default(uuid())
  restaurantGroupId   String   @map("restaurant_group_id")
  sourceRestaurantId  String   @map("source_restaurant_id")
  targetRestaurantIds Json     @map("target_restaurant_ids")
  itemsAdded          Int      @default(0) @map("items_added")
  itemsUpdated        Int      @default(0) @map("items_updated")
  itemsSkipped        Int      @default(0) @map("items_skipped")
  conflicts           Int      @default(0)
  syncedBy            String?  @map("synced_by")
  createdAt           DateTime @default(now()) @map("created_at")

  restaurantGroup RestaurantGroup @relation(fields: [restaurantGroupId], references: [id], onDelete: Cascade)

  @@index([restaurantGroupId])
  @@map("menu_sync_logs")
}
